name: React Doctor Check

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

permissions:
    contents: read
    pull-requests: write

jobs:
    react-doctor:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v5

            - uses: pnpm/action-setup@v4

            - uses: actions/setup-node@v5
              with:
                  node-version: "24"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run React Doctor
              id: doctor
              env:
                  NO_COLOR: "1"
              run: |
                  echo "=== apps/web ===" | tee react-doctor-report.txt
                  npx -y react-doctor@latest apps/web --verbose 2>&1 | tee -a react-doctor-report.txt || true
                  WEB_SCORE=$(npx -y react-doctor@latest apps/web --score 2>/dev/null || echo "N/A")

                  echo "" >> react-doctor-report.txt
                  echo "=== apps/admin ===" | tee -a react-doctor-report.txt
                  npx -y react-doctor@latest apps/admin --verbose 2>&1 | tee -a react-doctor-report.txt || true
                  ADMIN_SCORE=$(npx -y react-doctor@latest apps/admin --score 2>/dev/null || echo "N/A")

                  echo "" >> react-doctor-report.txt
                  echo "=== apps/waitlist ===" | tee -a react-doctor-report.txt
                  npx -y react-doctor@latest apps/waitlist --verbose 2>&1 | tee -a react-doctor-report.txt || true
                  WAITLIST_SCORE=$(npx -y react-doctor@latest apps/waitlist --score 2>/dev/null || echo "N/A")

                  echo "web_score=$WEB_SCORE" >> "$GITHUB_OUTPUT"
                  echo "admin_score=$ADMIN_SCORE" >> "$GITHUB_OUTPUT"
                  echo "waitlist_score=$WAITLIST_SCORE" >> "$GITHUB_OUTPUT"

            - name: Upload report artifact
              uses: actions/upload-artifact@v4
              with:
                  name: react-doctor-report
                  path: react-doctor-report.txt
                  retention-days: 30

            - name: Comment on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const report = fs.readFileSync('react-doctor-report.txt', 'utf8');
                      const webScore = '${{ steps.doctor.outputs.web_score }}' || 'N/A';
                      const adminScore = '${{ steps.doctor.outputs.admin_score }}' || 'N/A';
                      const waitlistScore = '${{ steps.doctor.outputs.waitlist_score }}' || 'N/A';

                      const body = [
                        '## React Doctor Report',
                        '',
                        '| App | Score |',
                        '|-----|-------|',
                        `| web | ${webScore} / 100 |`,
                        `| admin | ${adminScore} / 100 |`,
                        `| waitlist | ${waitlistScore} / 100 |`,
                        '',
                        '<details>',
                        '<summary>Full diagnostics</summary>',
                        '',
                        '```',
                        report,
                        '```',
                        '',
                        '</details>',
                      ].join('\n');

                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const existing = comments.find(c =>
                        c.user.type === 'Bot' && c.body.includes('React Doctor Report')
                      );

                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body,
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body,
                        });
                      }

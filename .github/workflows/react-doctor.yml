name: React Doctor Check

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    react-doctor:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v5

            - uses: pnpm/action-setup@v4

            - uses: actions/setup-node@v5
              with:
                  node-version: "24"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run React Doctor
              id: doctor
              run: |
                  npx -y react-doctor@latest apps/web --verbose 2>&1 | tee react-doctor-report.txt || true
                  SCORE=$(npx -y react-doctor@latest apps/web --score 2>/dev/null || echo "N/A")
                  echo "score=$SCORE" >> "$GITHUB_OUTPUT"

            - name: Upload report artifact
              uses: actions/upload-artifact@v4
              with:
                  name: react-doctor-report
                  path: react-doctor-report.txt
                  retention-days: 30

            - name: Comment on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const report = fs.readFileSync('react-doctor-report.txt', 'utf8');
                      const score = '${{ steps.doctor.outputs.score }}' || 'N/A';

                      const body = [
                        '## React Doctor Report',
                        '',
                        `**Score: ${score} / 100**`,
                        '',
                        '<details>',
                        '<summary>Full diagnostics</summary>',
                        '',
                        '```',
                        report,
                        '```',
                        '',
                        '</details>',
                      ].join('\n');

                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const existing = comments.find(c =>
                        c.user.type === 'Bot' && c.body.includes('React Doctor Report')
                      );

                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body,
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body,
                        });
                      }
